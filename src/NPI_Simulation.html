<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mumbai Noise Simulator — 3‑min Auto‑Update</title>
  <style>
    :root{
      --bg:#0b1020; --card:#111833; --muted:#97a3b6; --text:#e8ecf6; --accent1:#6a5acd; --accent2:#4f9cff;
      --ok:#34d399; --warn:#f59e0b; --high:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; background:linear-gradient(120deg,#0b1020 0%,#0e1430 60%,#151a3a 100%); color:var(--text)}
    header{display:flex;align-items:center;justify-content:space-between;gap:1rem; padding:20px 24px; position:sticky; top:0; backdrop-filter: blur(6px); background:rgba(11,16,32,.6); border-bottom:1px solid rgba(255,255,255,.06)}
    h1{font-size:clamp(18px,2.8vw,28px); margin:0; letter-spacing:.2px}
    .badge{font-size:12px; color:#cbd5e1; background:rgba(255,255,255,.08); padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.08)}

    .controls{display:flex;flex-wrap:wrap; gap:10px; align-items:center}
    .control{display:flex;align-items:center;gap:8px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.08); padding:8px 10px; border-radius:12px}
    .control input,.control select{background:transparent;border:none;color:var(--text); outline:none; font-size:14px; width:7rem}
    button{cursor:pointer; border:none; color:white; padding:10px 14px; border-radius:12px; background: linear-gradient(135deg, var(--accent2), var(--accent1)); box-shadow:0 8px 20px rgba(79,156,255,.25);} 
    button.secondary{background:rgba(255,255,255,.06)}

    main{padding:20px 24px 40px}
    .grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fill,minmax(240px,1fr))}
    .card{position:relative; background: radial-gradient(1200px 420px at -20% -20%, rgba(111,86,250,.22), transparent 60%),
      radial-gradient(800px 300px at 120% 140%, rgba(79,156,255,.18), transparent 55%),
      linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08); padding:16px; border-radius:18px; box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .city{display:flex; align-items:center; justify-content:space-between; gap:8px}
    .city h3{margin:0; font-size:16px}
    .pill{font-size:11px; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.08); color:#cbd5e1}
    .db{font-size:32px; font-weight:700; margin:10px 0 4px}
    .meta{font-size:12px; color:var(--muted)}
    .status{font-weight:600}
    .status.ok{color:var(--ok)} .status.warn{color:var(--warn)} .status.high{color:var(--high)}

    .section{margin-top:26px; display:flex; align-items:center; justify-content:space-between}
    .section h2{margin:0 0 10px; font-size:18px}

    table{width:100%; border-collapse:collapse; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); border-radius:14px; overflow:hidden}
    thead th{font-size:12px; text-align:left; color:#b7c3d6; background:rgba(255,255,255,.04)}
    th, td{padding:12px 10px; border-bottom:1px solid rgba(255,255,255,.06)}
    tbody tr:hover{background:rgba(255,255,255,.03)}

    .footer{margin-top:26px; font-size:12px; color:#9fb0c6}
    .countdown{font-variant-numeric: tabular-nums}

    @media (max-width:600px){
      .controls{flex-direction:column; align-items:stretch}
      .control{justify-content:space-between}
      .control input{width:auto}
    }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Noise Pollution — Mumbai & MMR (Synthetic)</h1>
      <div class="badge">Auto‑updates every <span id="intervalLabel">3</span> min · IST</div>
    </div>
    <div class="controls">
      <div class="control">
        <label>Stations/City</label>
        <select id="stationsPerCity">
          <option value="3">3</option>
          <option value="4" selected>4</option>
          <option value="5">5</option>
          <option value="6">6</option>
        </select>
      </div>
      <div class="control">
        <label>Interval (min)</label>
        <input id="intervalMin" type="number" value="3" min="1" step="1" />
      </div>
      <button id="refreshBtn" title="Generate now">Force refresh</button>
      <button id="exportBtn" class="secondary" title="Download latest JSON">Export JSON</button>
    </div>
  </header>

  <main>
    <div class="grid" id="cards"></div>

    <div class="section">
      <h2>Latest Station Readings</h2>
      <div class="countdown">Next update in: <span id="countdown">00:00</span></div>
    </div>

    <div style="overflow:auto; border-radius:14px">
      <table>
        <thead>
          <tr>
            <th>Timestamp (IST)</th>
            <th>City</th>
            <th>Station</th>
            <th>Lat</th>
            <th>Lon</th>
            <th>dB</th>
            <th>Category</th>
            <th>Peak Hr</th>
            <th>Traffic Idx</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="footer">Synthetic data only. Patterns include rush‑hour peaks, weekend effects, and occasional spikes to mimic construction/sirens.</div>
  </main>

<script>
// --- Core model (mirrors your Python generator) ---------------------------------
const IST_OFFSET_MIN = 330; // Asia/Kolkata
const NOISE_BOUNDS = [38, 102];
const CITIES = {
  "Mumbai":            [19.0760, 72.8777, 63],
  "Thane":             [19.2183, 72.9781, 60],
  "Navi Mumbai":       [19.0330, 73.0297, 58],
  "Kalyan-Dombivli":   [19.2350, 73.1290, 59],
  "Mira-Bhayandar":    [19.2952, 72.8544, 57],
  "Vasai-Virar":       [19.3919, 72.8397, 56],
  "Bhiwandi":          [19.3000, 73.0667, 58],
  "Ulhasnagar":        [19.2167, 73.1500, 57],
  "Ambarnath":         [19.2000, 73.2000, 56],
  "Badlapur":          [19.1667, 73.2333, 55],
  "Panvel":            [18.9894, 73.1175, 57],
  "Palghar":           [19.6967, 72.7730, 52],
  "Karjat":            [18.9100, 73.3200, 51],
  "Vasind":            [19.4089, 73.2625, 50],
  "Dahanu":            [19.9670, 72.7351, 49],
};

function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }
function randNorm(mu=0, sigma=1){ // Box-Muller
  let u=0, v=0; while(u===0) u=Math.random(); while(v===0) v=Math.random();
  return mu + sigma * Math.sqrt(-2.0*Math.log(u)) * Math.cos(2*Math.PI*v);
}
function categoryFromDb(db){
  if (db < 50) return "Quiet";
  if (db < 60) return "Moderate";
  if (db < 70) return "High";
  if (db < 85) return "Very High";
  return "Hazardous";
}
function timeOfDayBoost(d){ // Gaussian peaks around 09:00 & 19:00 IST
  const h = d.getHours() + d.getMinutes()/60;
  const morning = 10*Math.exp(-0.5 * Math.pow((h-9)/1.5, 2));
  const evening = 9*Math.exp(-0.5 * Math.pow((h-19)/1.8, 2));
  const night = (h >= 23 || h < 5) ? -12 : 0;
  return morning + evening + night;
}
function dayOfWeekBoost(d){
  const wd = d.getDay(); // 0 Sun ... 6 Sat
  if (wd === 5 || wd === 6) return 2; // Fri/Sat louder
  if (wd === 0 && d.getHours() < 11) return -3; // Sun morning quieter
  return 0;
}
function jitterCoord(base, span=0.035){ return base + (Math.random()*2-1)*span; }

// Station state
class Station{ constructor(city, id, lat, lon, base){
  this.city=city; this.id=id; this.lat=lat; this.lon=lon; this.base=base; this.state=(Math.random()*4-2);
  this.history=[]; // last N dB
} }

// Build stations
function makeStations(perCity, seed){
  // Seed is optional; for deterministic demo you can plug in mulberry32; we keep native Math.random for brevity
  const stations=[]; let idx=1;
  Object.entries(CITIES).forEach(([city,[lat,lon,base]])=>{
    for(let i=0;i<perCity;i++){
      const id = `${city.slice(0,3).toUpperCase()}-${String(i+1).padStart(2,'0')}`;
      const latJ = jitterCoord(lat), lonJ = jitterCoord(lon);
      const baseJ = base + (Math.random()*6-3);
      stations.push(new Station(city,id,latJ,lonJ,baseJ)); idx++;
    }
  });
  return stations;
}

function simulateBatch(stations, now){
  const tod = timeOfDayBoost(now);
  const dow = dayOfWeekBoost(now);
  const rows = [];
  for(const st of stations){
    const drift = randNorm(0.1, 0.25);
    const shock = randNorm(0, 2.5);
    st.state = clamp(st.state + drift + 0.35*shock, -10, 10);
    let spike = 0; if (Math.random() < 0.05) spike = 3 + Math.random()*9;
    let db = st.base + tod + dow + st.state + spike + randNorm(0,1.5);
    db = clamp(db, NOISE_BOUNDS[0], NOISE_BOUNDS[1]);
    const isPeak = (now.getHours()>=8 && now.getHours()<=10) || (now.getHours()>=18 && now.getHours()<=20) ? 1:0;
    const tIdx = clamp((db-45)/50, 0, 1);
    st.history.push(db); if(st.history.length>60) st.history.shift();

    rows.push({
      timestamp_ist: now.toISOString().replace('Z','+05:30'),
      city: st.city,
      station_id: st.id,
      lat: +st.lat.toFixed(6),
      lon: +st.lon.toFixed(6),
      noise_db: +db.toFixed(1),
      category: categoryFromDb(db),
      is_peak_hour: isPeak,
      traffic_index: +tIdx.toFixed(3),
    });
  }
  return rows;
}

// --- UI rendering --------------------------------------------------------------
const elCards = document.getElementById('cards');
const elBody  = document.getElementById('tableBody');
const elCountdown = document.getElementById('countdown');
const stationsPerCitySel = document.getElementById('stationsPerCity');
const intervalMinInput = document.getElementById('intervalMin');
const intervalLabel = document.getElementById('intervalLabel');
let stations = makeStations(parseInt(stationsPerCitySel.value,10));
let latestRows = [];
let timer = null, countdownTimer = null, nextAt = null;

function formatMMSS(ms){ const s=Math.max(0, Math.floor(ms/1000)); const m=String(Math.floor(s/60)).padStart(2,'0'); const r=String(s%60).padStart(2,'0'); return `${m}:${r}`; }
function statusClass(cat){ if(cat==='Quiet'||cat==='Moderate') return 'ok'; if(cat==='High'||cat==='Very High') return 'warn'; return 'high'; }

function render(rows){
  // City aggregates
  const byCity = {};
  rows.forEach(r=>{ if(!byCity[r.city]) byCity[r.city]={sum:0,count:0,max:0,cat:"",stations:0}; byCity[r.city].sum+=r.noise_db; byCity[r.city].count++; byCity[r.city].max=Math.max(byCity[r.city].max,r.noise_db); byCity[r.city].stations++; });
  const cardHtml = Object.entries(byCity).map(([city, agg])=>{
    const avg = agg.sum/agg.count; const cat = categoryFromDb(avg);
    return `<div class="card">
      <div class="city"><h3>${city}</h3><span class="pill">${agg.stations} stns</span></div>
      <div class="db">${avg.toFixed(1)} dB</div>
      <div class="meta">Peak: ${agg.max.toFixed(1)} dB · <span class="status ${statusClass(cat)}">${cat}</span></div>
    </div>`
  }).join('');
  elCards.innerHTML = cardHtml;

  // Table
  elBody.innerHTML = rows
    .sort((a,b)=> a.city.localeCompare(b.city) || a.station_id.localeCompare(b.station_id))
    .map(r=>`<tr>
      <td>${r.timestamp_ist}</td>
      <td>${r.city}</td>
      <td>${r.station_id}</td>
      <td>${r.lat}</td>
      <td>${r.lon}</td>
      <td><b>${r.noise_db}</b></td>
      <td>${r.category}</td>
      <td>${r.is_peak_hour ? 'Yes' : 'No'}</td>
      <td>${r.traffic_index}</td>
    </tr>`).join('');
}

function tickGenerate(){
  const now = new Date();
  latestRows = simulateBatch(stations, now);
  render(latestRows);
}

function schedule(intervalMs){
  if(timer) clearInterval(timer);
  if(countdownTimer) clearInterval(countdownTimer);
  intervalLabel.textContent = Math.round(intervalMs/60000);
  tickGenerate();
  nextAt = Date.now() + intervalMs;
  timer = setInterval(()=>{ tickGenerate(); nextAt = Date.now() + intervalMs; }, intervalMs);
  countdownTimer = setInterval(()=>{
    const rem = nextAt - Date.now();
    elCountdown.textContent = formatMMSS(rem);
  }, 250);
}

// Export JSON
function download(filename, text){
  const a = document.createElement('a');
  a.setAttribute('href', 'data:application/json;charset=utf-8,' + encodeURIComponent(text));
  a.setAttribute('download', filename);
  a.style.display='none'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
}

// Wire controls
document.getElementById('refreshBtn').addEventListener('click', ()=>{ tickGenerate(); nextAt = Date.now() + parseInt(intervalMinInput.value,10)*60000; });

document.getElementById('exportBtn').addEventListener('click', ()=>{
  const blob = JSON.stringify(latestRows, null, 2);
  const d = new Date();
  const y = d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  download(`latest_noise_${y}-${m}-${day}.json`, blob);
});

stationsPerCitySel.addEventListener('change', ()=>{
  stations = makeStations(parseInt(stationsPerCitySel.value,10));
  tickGenerate();
});

intervalMinInput.addEventListener('change', ()=>{
  const mins = Math.max(1, parseInt(intervalMinInput.value,10)||3);
  intervalMinInput.value = mins; schedule(mins*60000);
});

// Boot with 3‑minute schedule
schedule(3*60*1000);
</script>
</body>
</html>
